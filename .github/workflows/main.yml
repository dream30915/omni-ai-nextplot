name: üöÄ Auto Deploy OMNI-AI + NextPlot to Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch:  # ‡πÉ‡∏´‡πâ‡∏Å‡∏î deploy ‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡πÅ‡∏ó‡πá‡∏ö Actions

jobs:
  deploy:
    name: Build & Deploy to Cloud Run
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout Source
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Google Cloud SDK
      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          export_default_credentials: true

      # 3Ô∏è‚É£ Build Docker Image for Cloud Run
      - name: Build Docker image
        run: |
          gcloud builds submit --tag gcr.io/${{ secrets.GCP_PROJECT_ID }}/omni-ai-nextplot .

      # 4Ô∏è‚É£ Deploy to Cloud Run
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy omni-ai-nextplot \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/omni-ai-nextplot \
            --region asia-southeast1 \
            --platform managed \
            --allow-unauthenticated \
            --memory=512Mi \
            --set-env-vars "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }},LINE_TOKEN=${{ secrets.LINE_TOKEN }}" \
            --set-env-vars "GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }},GCP_SA_KEY=${{ secrets.GCP_SA_KEY }}"

      # 5Ô∏è‚É£ Confirm Deployment URL
      - name: Verify Deployment
        run: |
          echo "‚úÖ Deployment completed successfully."
          echo "üåê Check your service with: gcloud run services describe omni-ai-nextplot --region=asia-southeast1 --format='value(status.url)'"
